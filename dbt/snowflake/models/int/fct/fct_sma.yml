version: 2

models:
  - name: fct_sma
    columns:
      - name: ticker
        data_tests:
          - not_null
      - name: trading_date
        data_tests:
          - not_null
      - name: close
      - name: sma_5
      - name: sma_10
      - name: sma_20
      - name: last_sma_5
      - name: last_sma_10
      - name: last_sma_20


unit_tests:
  - name: test_check_sma_5
    description: "test is checking if the sma is calculated correctly."
    model: fct_sma
    overrides:
      macros:
        is_incremental: false
    given:
      - input: ref('stg_stock_data')
        rows:
          - {ticker: test, trading_date: 2020-01-01, close: 1.00}
          - {ticker: test, trading_date: 2020-01-02, close: 1.00}
          - {ticker: test, trading_date: 2020-01-03, close: 1.00}
          - {ticker: test, trading_date: 2020-01-04, close: 2.00}
          - {ticker: test, trading_date: 2020-01-05, close: 5.00}
          - {ticker: test, trading_date: 2020-01-06, close: 6.00}
    expect:
      rows:
        - {ticker: test, trading_date: 2020-01-01, close: 1.00, sma_5: 1.00}
        - {ticker: test, trading_date: 2020-01-02, close: 1.00, sma_5: 1.00}
        - {ticker: test, trading_date: 2020-01-03, close: 1.00, sma_5: 1.00}
        - {ticker: test, trading_date: 2020-01-04, close: 2.00, sma_5: 1.25}
        - {ticker: test, trading_date: 2020-01-05, close: 5.00, sma_5: 2.00}
        - {ticker: test, trading_date: 2020-01-06, close: 6.00, sma_5: 3.00}

  - name: test_check_last_value
    description: "test is checking if the last close is correct."
    model: fct_sma
    overrides:
      macros:
        is_incremental: false
    given:
      - input: ref('stg_stock_data')
        rows:
          - {ticker: test, trading_date: 2020-01-01, close: 1.00}
          - {ticker: test, trading_date: 2020-01-02, close: 1.00}
          - {ticker: test, trading_date: 2020-01-03, close: 1.00}
          - {ticker: test, trading_date: 2020-01-04, close: 2.00}
          - {ticker: test, trading_date: 2020-01-05, close: 5.00}
          - {ticker: test, trading_date: 2020-01-06, close: 6.00}
    expect:
      rows:
        - {ticker: test, trading_date: 2020-01-01, last_close: null}
        - {ticker: test, trading_date: 2020-01-02, last_close: 1.00}
        - {ticker: test, trading_date: 2020-01-03, last_close: 1.00}
        - {ticker: test, trading_date: 2020-01-04, last_close: 1.00}
        - {ticker: test, trading_date: 2020-01-05, last_close: 2.00}
        - {ticker: test, trading_date: 2020-01-06, last_close: 5.00}

  - name: test_check_last_sma
    description: "test is checking if the last sma is correct."
    model: fct_sma
    overrides:
      macros:
        is_incremental: false
    given:
      - input: ref('stg_stock_data')
        rows:
          - {ticker: test, trading_date: 2020-01-01, close: 1.00}
          - {ticker: test, trading_date: 2020-01-02, close: 1.00}
          - {ticker: test, trading_date: 2020-01-03, close: 1.00}
          - {ticker: test, trading_date: 2020-01-04, close: 2.00}
          - {ticker: test, trading_date: 2020-01-05, close: 5.00}
          - {ticker: test, trading_date: 2020-01-06, close: 6.00}
    expect:
      rows:
        - {ticker: test, trading_date: 2020-01-01, last_sma_5: null}
        - {ticker: test, trading_date: 2020-01-02, last_sma_5: 1.00}
        - {ticker: test, trading_date: 2020-01-03, last_sma_5: 1.00}
        - {ticker: test, trading_date: 2020-01-04, last_sma_5: 1.00}
        - {ticker: test, trading_date: 2020-01-05, last_sma_5: 1.25}
        - {ticker: test, trading_date: 2020-01-06, last_sma_5: 2.00}
