version: 2
  
models:
  - name: fct_close_signals
    columns:
      - name: ticker
        data_tests:
          - not_null
      - name: close_date
        data_tests:
          - not_null
      - name: trend
      - name: segment 
        data_type: number


unit_tests:

  - name: test_close_signals
    description: "test is checking if there is no duplicated rows with (ticker, trading_date) primary key after deduplication process."
    model: fct_close_signals
    overrides:
      macros:
        is_incremental: false
    given:
      - input: ref('fct_trend_segments')
        rows:
          - {trading_date: 2020-10-09, ticker: AAA, trend: null, is_new_trend: 0, segment: 0}
          - {trading_date: 2020-10-10, ticker: AAA, trend: 'up', is_new_trend: 1, segment: 1}
          - {trading_date: 2020-10-11, ticker: AAA, trend: 'up', is_new_trend: 0, segment: 1}
          - {trading_date: 2020-10-12, ticker: AAA, trend: 'up', is_new_trend: 0, segment: 1}
          - {trading_date: 2020-10-13, ticker: AAA, trend: null, is_new_trend: 0, segment: 1}
          - {trading_date: 2020-10-14, ticker: AAA, trend: null, is_new_trend: 0, segment: 1}
          - {trading_date: 2020-10-15, ticker: AAA, trend: 'up', is_new_trend: 1, segment: 2}
          - {trading_date: 2020-10-16, ticker: AAA, trend: 'up', is_new_trend: 0, segment: 2}
          - {trading_date: 2020-10-17, ticker: AAA, trend: 'up', is_new_trend: 0, segment: 2}
          - {trading_date: 2020-10-18, ticker: AAA, trend: null, is_new_trend: 0, segment: 2}
      - input: ref('fct_close_prices')
        rows:
          - {trading_date: 2020-10-09, ticker: AAA, close: 10}
          - {trading_date: 2020-10-10, ticker: AAA, close: 11}
          - {trading_date: 2020-10-11, ticker: AAA, close: 13}
          - {trading_date: 2020-10-12, ticker: AAA, close: 14}
          - {trading_date: 2020-10-13, ticker: AAA, close: 15}
          - {trading_date: 2020-10-14, ticker: AAA, close: 16}
          - {trading_date: 2020-10-15, ticker: AAA, close: 17}
          - {trading_date: 2020-10-16, ticker: AAA, close: 18}
          - {trading_date: 2020-10-17, ticker: AAA, close: 19}
          - {trading_date: 2020-10-18, ticker: AAA, close: 20}
    expect:
      rows:
          - {close_date: 2020-10-12, ticker: AAA, trend: 'up', segment: 1, close_price: 14}
          - {close_date: 2020-10-17, ticker: AAA, trend: 'up', segment: 2, close_price: 19}