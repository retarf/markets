version: 2
  
models:
  - name: mart_return_data
    columns:
      - name: ticker
        data_tests:
          - not_null
      - name: trend
        data_tests:
          - not_null
      - name: open_date
        data_tests:
          - not_null
      - name: open_price
        data_tests:
          - not_null
      - name: close_date
        data_tests:
          - not_null
      - name: close_price
        data_tests:
          - not_null
      - name: profit_per_share
        data_tests:
          - not_null
      - name: return_rate
        data_tests:
          - not_null
      - name: segment
        data_tests:
          - not_null


unit_tests:
  - name: test_return_rate_calculations
    description: "test is checking if there is no duplicated rows with (ticker, trading_date) primary key after deduplication process."
    model: mart_return_data
    overrides:
      macros:
        is_incremental: false
    given:
      - input: ref('fct_open_signals')
        rows:
          - {open_date: 2020-10-12, ticker: AAA, trend: 'up', segment: 1, open_price: 10}
          - {open_date: 2020-10-17, ticker: AAA, trend: 'up', segment: 2, open_price: 10}
          - {open_date: 2020-10-20, ticker: AAA, trend: 'down', segment: 3, open_price: 20}
      - input: ref('fct_close_signals')
        rows:
          - {close_date: 2020-10-13, ticker: AAA, trend: 'up', segment: 1, close_price: 12}
          - {close_date: 2020-10-18, ticker: AAA, trend: 'up', segment: 2, close_price: 14}
          - {close_date: 2020-10-21, ticker: AAA, trend: 'down', segment: 3, close_price: 10}
    expect:
      rows:
        - {ticker: AAA, open_date: 2020-10-12, open_price: 10, close_date: 2020-10-13, close_price: 12, profit_per_share: 2, return_rate: 20, segment: 1}
        - {ticker: AAA, open_date: 2020-10-17, open_price: 10, close_date: 2020-10-18, close_price: 14, profit_per_share: 4, return_rate: 40, segment: 2}
        - {ticker: AAA, open_date: 2020-10-20, open_price: 20, close_date: 2020-10-21, close_price: 10, profit_per_share: 10, return_rate: 50, segment: 3}