version: 2

models:
  - name: stg_stock_data
    columns:
      - name: ticker
        data_tests:
          - not_null
      - name: trading_date
        data_tests:
          - not_null
      - name: open
        data_tests:
          - not_null
      - name: high
        data_tests:
          - not_null
      - name: low
        data_tests:
          - not_null
      - name: close
        data_tests:
          - not_null
      - name: volume
        data_tests:
          - not_null
      - name: load_ts
        data_tests:
          - not_null
      - name: source_file
        data_tests:
          - not_null
    tests:
      - dbt_utils.unique_combination_of_columns:
          arguments:
            combination_of_columns:
              - ticker
              - trading_date

unit_tests:
  - name: test_check_deduplication
    description: "test is checking if there is no duplicated rows with (ticker, trading_date) primary key after deduplication process."
    model: stg_stock_data
    overrides:
      macros:
        is_incremental: false
    given:
      - input: source('raw', 'raw_stock_data')
        rows:
          - {ticker: test, trading_date: 2020-01-01, open: 5.00, high: 5.00, low: 5.00, close: 5.00, volume: 100, source_file: 20210101_test.csv, load_ts: 2025-01-01T10:00:00.000+0000}
          - {ticker: test, trading_date: 2020-01-01, open: 6.00, high: 6.00, low: 6.00, close: 6.00, volume: 200, source_file: 20210102_test.csv, load_ts: 2025-01-02T10:00:00.000+0000}
    expect:
      rows:
        - {ticker: test, trading_date: 2020-01-01, open: 6.00, high: 6.00, low: 6.00, close: 6.00, volume: 200, source_file: 20210102_test.csv, load_ts: 2025-01-02T10:00:00.000+0000}
